name: Build LaTeX (changed subjects only)

on:
  push:
    paths:
      - "tex/**"
      - "template/**"
      - ".github/workflows/latex.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  detect:
    name: Detect changed subjects
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.detect.outputs.matrix }}
      subjects: ${{ steps.detect.outputs.subjects }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 必须，否则 diff 不可靠

      - name: Detect
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # workflow_dispatch 没有 before；就用上一次提交兜底
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BEFORE="$(git rev-parse HEAD~1 || true)"
          fi

          echo "BEFORE=$BEFORE"
          echo "AFTER=$AFTER"

          # 找变更文件
          if [[ -n "$BEFORE" ]]; then
            CHANGED="$(git diff --name-only "$BEFORE" "$AFTER" || true)"
          else
            CHANGED="$(git diff --name-only HEAD~1 HEAD || true)"
          fi

          echo "Changed files:"
          echo "$CHANGED"

          # 只要 template/ 变了，就认为所有学科都要编译
          REBUILD_ALL=0
          if echo "$CHANGED" | grep -qE '^template/'; then
            REBUILD_ALL=1
          fi

          declare -A SUBJ=()

          if [[ "$REBUILD_ALL" == "1" ]]; then
            # 全部学科：tex/<Subject>/*
            while IFS= read -r d; do
              s="$(basename "$d")"
              SUBJ["$s"]=1
            done < <(find tex -mindepth 1 -maxdepth 1 -type d -print)
          else
            # 根据变更文件提取 tex/<Subject>/...
            while IFS= read -r f; do
              if [[ "$f" =~ ^tex/([^/]+)/ ]]; then
                SUBJ["${BASH_REMATCH[1]}"]=1
              fi
            done <<< "$CHANGED"
          fi

          # 组装 matrix：每个 subject 对应一个 root_file（优先 Subject/Subject.tex，否则找该目录下第一份 .tex）
          ITEMS=()
          SUBJECTS_LIST=()

          for s in "${!SUBJ[@]}"; do
            wd="tex/$s"
            root="$wd/$s.tex"
            if [[ ! -f "$root" ]]; then
              root="$(find "$wd" -maxdepth 1 -type f -name '*.tex' | head -n 1 || true)"
            fi
            if [[ -z "$root" ]]; then
              echo "::warning::No root .tex found under $wd, skip."
              continue
            fi

            # item: {"subject":"X","working_directory":"tex/X","root_file":"X.tex"}
            ITEMS+=("{\"subject\":\"$s\",\"working_directory\":\"$wd\",\"root_file\":\"$(basename "$root")\"}")
            SUBJECTS_LIST+=("$s")
          done

          if [[ "${#ITEMS[@]}" == "0" ]]; then
            echo "No subjects to build."
            echo "matrix=" >> "$GITHUB_OUTPUT"
            echo "subjects=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          JSON="{\"include\":[${ITEMS[*]}]}"
          JSON="${JSON//} {/},{\"}"  # 防止 bash join 问题（简单拼接修正）

          # 更稳的拼接方式
          JSON="{\"include\":["
          for i in "${!ITEMS[@]}"; do
            if [[ "$i" -gt 0 ]]; then JSON+=","
            fi
            JSON+="${ITEMS[$i]}"
          done
          JSON+="]}"

          echo "Will build subjects: ${SUBJECTS_LIST[*]}"
          echo "matrix=$JSON" >> "$GITHUB_OUTPUT"
          echo "subjects=${SUBJECTS_LIST[*]}" >> "$GITHUB_OUTPUT"

          {
            echo "## Detect result"
            echo ""
            echo "**Will build:** ${SUBJECTS_LIST[*]}"
          } >> "$GITHUB_STEP_SUMMARY"

  build:
    name: Build PDFs
    needs: detect
    if: ${{ needs.detect.outputs.matrix != '' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Show plan
        run: |
          echo "Subject: ${{ matrix.subject }}"
          echo "Working dir: ${{ matrix.working_directory }}"
          echo "Root file: ${{ matrix.root_file }}"

      - name: Compile ${{ matrix.subject }}
        uses: xu-cheng/latex-action@v3
        env:
          TEXINPUTS: "../../template//:../../template/figures//:./:"
        with:
          working_directory: ${{ matrix.working_directory }}
          root_file: ${{ matrix.root_file }}
          latexmk_use_xelatex: true
          args: -pdfxe -interaction=nonstopmode -file-line-error -f
          cache: true

      - name: Upload PDF artifact (${{ matrix.subject }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: PDF-${{ matrix.subject }}
          path: ${{ matrix.working_directory }}/${{ matrix.subject }}.pdf
          if-no-files-found: warn

      - name: Upload build logs (${{ matrix.subject }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Logs-${{ matrix.subject }}
          path: |
            ${{ matrix.working_directory }}/*.log
            ${{ matrix.working_directory }}/*.fls
            ${{ matrix.working_directory }}/*.fdb_latexmk
            ${{ matrix.working_directory }}/*.bcf
            ${{ matrix.working_directory }}/*.blg
            ${{ matrix.working_directory }}/*.bbl
            ${{ matrix.working_directory }}/*.out
            ${{ matrix.working_directory }}/*.toc
          if-no-files-found: warn
