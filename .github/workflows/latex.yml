name: Build LaTeX (changed subjects)

on:
  push:
    paths:
      - "tex/**"
      - "template/**"
      - ".github/workflows/latex.yml"
  workflow_dispatch:
    inputs:
      subject:
        description: "Optional: compile only one subject folder name (e.g., Functional_Analysis)"
        required: false
        default: ""

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: set-matrix
        shell: bash
        run: |
          set -euo pipefail

          # 1) 手动触发：如果指定了 subject，就只编译这一门
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.subject }}" ]; then
            subj="${{ inputs.subject }}"
            root="tex/${subj}/${subj}.tex"
            if [ ! -f "$root" ]; then
              echo "::error::Cannot find root file: $root"
              exit 1
            fi
            echo "matrix={\"include\":[{\"subject\":\"$subj\",\"root\":\"$root\"}]}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 2) push：计算 diff 范围
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # 首次 push / before 为空时兜底
          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            RANGE="$AFTER"
          else
            RANGE="$BEFORE..$AFTER"
          fi

          echo "Diff range: $RANGE"
          CHANGED="$(git diff --name-only $RANGE || true)"
          echo "$CHANGED"

          # 3) 如果 template 变了：编译全部学科
          if echo "$CHANGED" | grep -qE '^template/'; then
            echo "Template changed -> compile ALL subjects"
            SUBJECTS="$(ls -1 tex | tr '\n' ' ')"
          else
            # 否则只编译变更涉及到的 tex/<subject>/...
            SUBJECTS="$(echo "$CHANGED" | awk -F/ '/^tex\//{print $2}' | sort -u | tr '\n' ' ')"
          fi

          # 若没有任何学科变更，给空矩阵（build job 会跳过）
          if [ -z "$SUBJECTS" ]; then
            echo "No subject changes detected."
            echo "matrix={\"include\":[]}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 4) 组装 matrix（每个 subject 对应一个 root）
          JSON='{"include":['
          first=1
          for subj in $SUBJECTS; do
            root="tex/${subj}/${subj}.tex"
            if [ ! -f "$root" ]; then
              echo "::warning::Skip ${subj}: cannot find ${root}"
              continue
            fi
            if [ $first -eq 0 ]; then JSON+=","
            else first=0
            fi
            JSON+="{\"subject\":\"${subj}\",\"root\":\"${root}\"}"
          done
          JSON+="]}"

          echo "matrix=$JSON" >> "$GITHUB_OUTPUT"

  build:
    needs: detect
    if: ${{ fromJson(needs.detect.outputs.matrix).include[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Compile ${{ matrix.subject }}
        uses: xu-cheng/latex-action@v3
        env:
            TEXINPUTS: "${{ github.workspace }}/template//:"
        with:
          root_file: ${{ matrix.root }}
          latexmk_use_xelatex: true
          args: -f -interaction=nonstopmode -file-line-error
          cache: true

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v4
        with:
          name: PDF-${{ matrix.subject }}
          path: ${{ format('tex/{0}/{0}.pdf', matrix.subject) }}
          if-no-files-found: error

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Logs-${{ matrix.subject }}
          path: |
            tex/${{ matrix.subject }}/**/*.log
            tex/${{ matrix.subject }}/**/*.fls
            tex/${{ matrix.subject }}/**/*.fdb_latexmk
            tex/${{ matrix.subject }}/**/*.bcf
            tex/${{ matrix.subject }}/**/*.bbl
            tex/${{ matrix.subject }}/**/*.blg
            tex/${{ matrix.subject }}/**/*.out
            tex/${{ matrix.subject }}/**/*.toc
          if-no-files-found: warn
