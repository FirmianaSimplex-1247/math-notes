name: Build LaTeX (changed subjects)

on:
  push:
    paths:
      - "tex/**"
      - "template/**"
      - ".github/workflows/latex.yml"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 为了能做 git diff

      - name: Detect changed subjects
        id: detect
        shell: bash
        run: |
          set -e

          # 显式映射：学科 -> 主 tex 文件（不会串）
          SUBJECTS=(
            "Functional_Analysis:tex/Functional_Analysis/Functional_Analysis.tex"
            "Stochastic_Process:tex/Stochastic_Process/Stochastic_Process.tex"
          )

          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.sha }}"

          # 新分支第一次 push 时 before 可能是全零
          if [[ "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
            BEFORE="$(git rev-list --max-parents=0 HEAD | tail -n 1)"
          fi

          echo "Diff range: $BEFORE..$AFTER"
          CHANGED_FILES="$(git diff --name-only "$BEFORE" "$AFTER" || true)"
          echo "$CHANGED_FILES"

          TO_BUILD=()
          for item in "${SUBJECTS[@]}"; do
            name="${item%%:*}"
            main="${item#*:}"

            folder="tex/$name/"
            if echo "$CHANGED_FILES" | grep -qE "^${folder}" \
               || echo "$CHANGED_FILES" | grep -qE "^template/" ; then
              TO_BUILD+=("$main")
            fi
          done

          if [[ ${#TO_BUILD[@]} -eq 0 ]]; then
            echo "build_any=false" >> $GITHUB_OUTPUT
            echo "root_files=" >> $GITHUB_OUTPUT
          else
            echo "build_any=true" >> $GITHUB_OUTPUT
            # 输出为多行，方便后面循环
            {
              echo "root_files<<EOF"
              printf "%s\n" "${TO_BUILD[@]}"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi

      - name: Install TeX Live + latexmk
        if: steps.detect.outputs.build_any == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-full latexmk

      - name: Compile changed subjects
        if: steps.detect.outputs.build_any == 'true'
        shell: bash
        env:
          # 把 template 加到 TeX 搜索路径里（关键！）
          TEXINPUTS: "${{ github.workspace }}/template//:"
        run: |
          set -e
          echo "${{ steps.detect.outputs.root_files }}" | while IFS= read -r main; do
            [[ -z "$main" ]] && continue
            echo "=== Building: $main ==="
            latexmk -cd -xelatex -f -interaction=nonstopmode -file-line-error "$main"
          done

      - name: Upload PDFs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: PDFs
          path: |
            tex/**/**/*.pdf
          if-no-files-found: warn

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Logs
          path: |
            tex/**/**/*.log
            tex/**/**/*.fls
            tex/**/**/*.fdb_latexmk
          if-no-files-found: warn
